<?php
/**
 * Functions which enhance the theme by hooking into WordPress
 *
 * @package narasix
 */

/**
 * Adds custom classes to the array of body classes.
 *
 * @param array $classes Classes for the body element.
 * @return array
 */
function narasix_body_classes( $classes ) {
	// Adds a class of hfeed to non-singular pages.
	if ( ! is_singular() ) {
		$classes[] = 'hfeed';
	}

	// Adds a class of no-sidebar when there is no sidebar present.
	if ( ! is_active_sidebar( 'sidebar-1' ) ) {
		$classes[] = 'no-sidebar';
	}

	$narasix_enable_bradcrumb = get_theme_mod( 'narasix_enable_breadcrumb', 'hide' );
	if ( $narasix_enable_bradcrumb === 'show' ) {
		$classes[] = 'narasix-breadcrumb-active';
	}

	return $classes;
}
add_filter( 'body_class', 'narasix_body_classes' );

/**
 * Add a pingback url auto-discovery header for single posts, pages, or attachments.
 */
function narasix_pingback_header() {
	if ( is_singular() && pings_open() ) {
		printf( '<link rel="pingback" href="%s">', esc_url( get_bloginfo( 'pingback_url' ) ) );
	}
}
add_action( 'wp_head', 'narasix_pingback_header' );

add_editor_style('css/editor-style.css');

	/**
	 * Disable the emoji's
	 */
	function disable_emojis() {
		remove_action( 'wp_head', 'print_emoji_detection_script', 7 );
		remove_action( 'admin_print_scripts', 'print_emoji_detection_script' );
		remove_action( 'wp_print_styles', 'print_emoji_styles' );
		remove_action( 'admin_print_styles', 'print_emoji_styles' ); 
		remove_filter( 'the_content_feed', 'wp_staticize_emoji' );
		remove_filter( 'comment_text_rss', 'wp_staticize_emoji' ); 
		remove_filter( 'wp_mail', 'wp_staticize_emoji_for_email' );
		add_filter( 'tiny_mce_plugins', 'disable_emojis_tinymce' );
		add_filter( 'wp_resource_hints', 'disable_emojis_remove_dns_prefetch', 10, 2 );
	}
	add_action( 'init', 'disable_emojis' );
   
   /**
	* Filter function used to remove the tinymce emoji plugin.
	* 
	* @param array $plugins 
	* @return array Difference betwen the two arrays
	*/
   function disable_emojis_tinymce( $plugins ) {
	if ( is_array( $plugins ) ) {
	return array_diff( $plugins, array( 'wpemoji' ) );
	} else {
	return array();
	}
   }
   
   /**
	* Remove emoji CDN hostname from DNS prefetching hints.
	*
	* @param array $urls URLs to print for resource hints.
	* @param string $relation_type The relation type the URLs are printed for.
	* @return array Difference betwen the two arrays.
	*/
   function disable_emojis_remove_dns_prefetch( $urls, $relation_type ) {
	if ( 'dns-prefetch' == $relation_type ) {
	/** This filter is documented in wp-includes/formatting.php */
	$emoji_svg_url = apply_filters( 'emoji_svg_url', 'https://s.w.org/images/core/emoji/2/svg/' );
   
   $urls = array_diff( $urls, array( $emoji_svg_url ) );
	}
   
   return $urls;
   }

   add_filter( 'the_content', 'narasix_lazyload_images' );
   add_filter( 'widget_text', 'narasix_lazyload_images' );
   add_filter( 'wp_get_attachment_image_attributes', 'narasix_lazyload', 10, 2 );
   
   // Replace the image attributes in Post/Page Content
   function narasix_lazyload_images( $content ) {
	 $content = preg_replace( '/(<img.+)(src)/Ui', '$1data-$2', $content );
	 $content = preg_replace( '/(<img.+)(srcset)/Ui', '$1data-$2', $content );
	 return $content;
   }
   
   // Replace the image attributes in Post Listing, Related Posts, etc.
   function narasix_lazyload( $atts, $attachment ) {
	 $atts['data-src'] = $atts['src'];
	 unset( $atts['src'] );
	 
	 if( isset( $atts['srcset'] ) ) {
	   $atts['data-srcset'] = $atts['srcset'];
	   unset( $atts['srcset'] );
	 }
   
	 return $atts;
   }

   //excerpt text
   function excerpt($limit) {
	$excerpt = explode(' ', get_the_excerpt(), $limit);

	if (count($excerpt) >= $limit) {
		array_pop($excerpt);
		$excerpt = implode(" ", $excerpt) . '...';
	} else {
		$excerpt = implode(" ", $excerpt);
	}

	$excerpt = preg_replace('`\[[^\]]*\]`', '', $excerpt);

	return $excerpt;
	}

	function content($limit) {
	$content = explode(' ', get_the_content(), $limit);

	if (count($content) >= $limit) {
		array_pop($content);
		$content = implode(" ", $content) . '...';
	} else {
		$content = implode(" ", $content);
	}

	$content = preg_replace('/\[.+\]/','', $content);
	$content = apply_filters('the_content', $content); 
	$content = str_replace(']]>', ']]&gt;', $content);

	return $content;
	}